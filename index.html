<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>

<button id='login'>login to spotify</button>
<button id='current_playback'>show current playback</button>
<br>
<!-- <button id='show_all_playlists'>show all playlists</button> -->
<br>
<input type="text" id="playlist_input">search playlist</input>
<button id='get_playlist'>print playlist detail</button>
<br>
<div id='currentPlaylistDiv'>
</div>


<script>
var redirect_uri = 'https://localhost/spotifyapi/';
var scopes = 'user-read-private user-read-email';

var url = String(window.location);
if(url.search(/=/)!=-1){
    var code = url.slice(url.search(/=/)+1,);
}
if(code){
    token = get_token();
    // console.log(code);
}
// var token = 0;
var playlists = [];
// var playlist_tracks = {};

$(document).ready(function(){
    $('#login').click(function(){
        login();
        // token += 10;
        // console.log('yeah',token);
    });

    $('#show_all_playlists').click(function(){
        if(playlists.length == 0){ //alreadt executed
            get_all_playlists();
        }
        // console.log(playlists);
    });

    // $('#current_playback').unbind('click');
    // $('#current_playback').on('click',function(){
    //     // token += 1;
    // // })
    // // $(document).on('click','#current_playback', function(){
    //     // console.log(token);
    // });
    $('#current_playback').click(function(){
        // current_playback(token);
        play = spott_get('https://api.spotify.com/v1/me/player', token, function(xhr){
            console.log(xhr['item']['name'],'by',xhr['item']['artists'][0]['name']);
      });
        // console.log(play.responseJSON); 
        // if(token){
        // }
    });

    $('#get_playlist').click(function(){ //get full playlist details including all tacks
        get_all_playlists();
        name = $('#playlist_input').val();
        var playlist_id = '';
        var playlist_name = '';
        for(var i=0; i<playlists.length; i++) {
            if(playlists[i]['name'].indexOf(name) != -1){
                playlist_id = playlists[i]['id'];
                playlist_name = playlists[i]['name'];
            }
        }
        var current_playlist;
        if(playlist_id != ''){
            spott_get_sync('https://api.spotify.com/v1/playlists/'+playlist_id, token, function(xhr){
                // console.log(xhr);
                current_playlist = xhr;
            });
            // console.log(current_playlist);
            // playlist_tracks[playlist_name] = [];
            var continuue = true
            var next_url = 'https://api.spotify.com/v1/playlists/'+playlist_id+'/tracks?limit=100';
            var temp = [];
            i=0;
            while(continuue){
                spott_get_sync(next_url, token, function(xhr){
                    // console.log(xhr['items']);
                    // for(var i in xhr['items']){
                    // }
                    // playlist_tracks[playlist_name] = playlist_tracks[playlist_name].concat(xhr['items']);
                    temp = temp.concat(xhr['items']);
                    if(xhr['next']){
                        next_url = xhr['next'];
                    }else{
                        continuue = false;
                    }
                });
                i++
                if(i>=5){
                    break;
                }
            }
            current_playlist['tracks']['items'] = temp; //replace
            console.log(current_playlist);
            sortedArtistArr = ArtistDistribution(current_playlist['tracks']['items']);
            sortedArtistArr.splice(0,0,['artist','number']);
            image_url = current_playlist['images'][0]['url'];
            playlistDivhtml = '<img src="'+image_url+'" width="200px">\
                                <div id="playlist_piechart" style="width: 900px; height: 500px;"></div>';
            $('#currentPlaylistDiv').html(playlistDivhtml);

            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(function(){
                var data = google.visualization.arrayToDataTable(sortedArtistArr);
                var options = {
                  title: 'Artist pie chart of '+playlist_name,
                  pieHole: 0.2,
                };
                var chart = new google.visualization.PieChart(document.getElementById('playlist_piechart'));
                chart.draw(data, options);    
            });

            // sortedArtistArr = sortedArtistArr.toString.replace(/'/g, '"');
            // sortedArtistArr = JSON.parse(sortedArtistArr);
            // console.log($.isArray(sortedArtistArr),sortedArtistArr);
            // function drawChart(sortedArtistArr) {
            //     // sortedArtistArr = [['artist','number'],['Joji',9],['Laura',8],['Ille',7]];

            // }

        }else{
            console.log('failure');
        }
        // playlist_id = $('#playlist_input').val();
        // // `329i010xBb8kqife9WYVu7`
    });
    


});

</script>
</body>
</html>